<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Nonograph - Anonymous Publishing Service</title>
        <link rel="icon" href="data:," />

        <!-- Open Graph -->
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://nonograph.com/" />
        <meta
            property="og:title"
            content="Nonograph - Publish anything anonymously with one click"
        />
        <meta
            property="og:description"
            content="Self-hosted anonymous publishing platform. No accounts, no tracking, no compromise. Write anonymously, publish instantly, read privately."
        />
        <meta property="og:site_name" content="Nonograph" />
        <meta property="og:locale" content="en_US" />

        <!-- Additional Meta Tags -->
        <meta
            name="description"
            content="Self-hosted anonymous publishing platform. No accounts, no tracking, no compromise. Write anonymously, publish instantly, read privately."
        />
        <meta
            name="keywords"
            content="anonymous publishing, privacy, self-hosted, tor, hidden service, markdown, censorship resistant, surveillance-free"
        />
        <meta name="author" content="Nonograph" />
        <meta name="robots" content="index, follow" />
        <link rel="canonical" href="https://nonograph.com/" />
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                -webkit-tap-highlight-color: transparent;
            }
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                padding: 40px;
                line-height: 1.6;
                background: #ffffff;
                color: #333;
            }
            .container {
                position: relative;
                max-width: 1000px;
                margin: 0 auto;
            }
            .writingarea {
                width: 700px;
                margin: 0 auto;
                position: relative;
            }
            .content {
                width: 100%;
            }
            .sidebar {
                position: absolute;
                left: 50%;
                margin-left: 390px;
                top: 0px;
                width: 200px;
                text-align: left;
            }
            input[type="text"],
            textarea {
                width: 100%;
                padding: 0;
                border: none;
                font-size: 18px;
                background: transparent;
                font-family: Georgia, "Times New Roman", Times, serif;
                box-shadow: none;
                -webkit-box-shadow: none;
                -moz-box-shadow: none;
                -webkit-appearance: none;
                -moz-appearance: none;
            }
            input[type="text"]:focus,
            textarea:focus {
                outline: none;
            }
            input[type="text"]::placeholder,
            textarea::placeholder {
                color: #999;
                opacity: 1;
            }
            input[type="text"] {
                font-size: 30px;
                font-weight: 600;
                margin-bottom: 0;
                height: 60px;
            }
            input[type="text"].author-input {
                font-size: 16px;
                font-weight: 400;
                height: 24px;
                margin-bottom: 16px;
                color: #666;
            }
            textarea {
                min-height: 100px;
                font-size: 18px;
                resize: none;
                line-height: 1.6;
                -webkit-overflow-scrolling: touch;
            }
            button {
                background: #333;
                color: white;
                padding: 16px 32px;
                border: none;
                border-radius: 2px;
                cursor: pointer;
                font-size: 14px;
                margin-bottom: 16px;
                box-shadow: none;
                -webkit-box-shadow: none;
                -moz-box-shadow: none;
                margin-top: 0;
                min-height: 44px;
                transition: background-color 0.2s ease;
                -webkit-tap-highlight-color: transparent;
            }
            button:hover {
                background: #000;
            }
            button:active {
                background: #111;
                transform: translateY(1px);
            }
            button:disabled {
                background: #999;
                cursor: not-allowed;
            }
            .char-count {
                font-size: 11px;
                color: #999;
                margin-bottom: 16px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .char-count.over-limit {
                color: #e74c3c;
            }
            label {
                display: block;
                font-size: 12px;
                color: #666;
                margin-bottom: 4px;
            }
            .links {
                font-size: 12px;
                display: flex;
                flex-direction: column;
                gap: 4px;
            }
            .links a {
                color: #666;
                text-decoration: none;
            }
            .links a:hover {
                color: #333;
                text-decoration: underline;
            }

            /* Progress Circle Styles */
            .progress-circle {
                width: 16px;
                height: 16px;
                flex-shrink: 0;
            }
            .progress-circle circle {
                transition: stroke 0.3s ease;
            }
            .progress-circle .background {
                fill: none;
                stroke: #e0e0e0;
                stroke-width: 3;
            }
            .progress-circle .progress {
                fill: none;
                stroke: #666;
                stroke-width: 3;
                stroke-linecap: round;
                transform: rotate(-90deg);
                transform-origin: 50% 50%;
                transition:
                    stroke 0.3s ease,
                    stroke-dashoffset 0.3s ease;
            }

            /* Editor Menu Styles */
            .editor-menu {
                position: absolute;
                background: white;
                border: 1px solid #ddd;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                padding: 4px;
                z-index: 1000;
                display: none;
                max-height: 300px;
                overflow-y: auto;
                min-width: 200px;
            }
            .editor-menu.active {
                display: block;
            }
            .editor-menu::-webkit-scrollbar {
                width: 8px;
            }
            .editor-menu::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 4px;
            }
            .editor-menu::-webkit-scrollbar-thumb {
                background: #ccc;
                border-radius: 4px;
            }
            .editor-menu::-webkit-scrollbar-thumb:hover {
                background: #999;
            }
            .menu-item {
                padding: 4px 12px;
                cursor: pointer;
                font-size: 14px;
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                color: #333;
                border-radius: 2px;
                display: flex;
                align-items: center;
                gap: 8px;
                white-space: nowrap;
            }
            .menu-item:hover {
                background: #f5f5f5;
            }
            .menu-item.selected {
                background: #e8e8e8;
            }
            .menu-label {
                font-weight: 500;
            }
            .menu-shortcut {
                font-size: 12px;
                color: #999;
                margin-left: auto;
            }

            /* Mobile Header */
            .mobile-header {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: white;
                border-bottom: 1px solid #e0e0e0;
                padding: 8px 16px; /* Reduced from 12px to 8px */
                z-index: 100;
                align-items: center;
                justify-content: space-between;
                height: 48px; /* Fixed height for the header */
            }

            /* Mobile Styles */
            @media (max-width: 1040px) {
                .container {
                }
                .writingarea {
                    width: 100%;
                    max-width: 700px;
                }
                .sidebar {
                    position: static;
                    left: auto;
                    margin-left: 0;
                    margin-top: 32px;
                    width: 100%;
                    text-align: left;
                    display: flex;
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 16px;
                }
                .sidebar button {
                    width: 100%;
                    max-width: 200px;
                }
            }

            @media (max-width: 768px) {
                body {
                    padding: 16px;
                }
                .container {
                    padding: 0;
                }
                .writingarea {
                    width: 100%;
                }
                input[type="text"] {
                    font-size: 24px;
                    height: 50px;
                    line-height: 1.3;
                }
                input[type="text"].author-input {
                    font-size: 16px;
                    height: 32px;
                }
                textarea {
                    font-size: 16px;
                    line-height: 1.5;
                    min-height: 200px;
                }
                .sidebar {
                    margin-top: 24px;
                    gap: 12px;
                }
                .sidebar button {
                    padding: 14px 28px;
                    font-size: 16px;
                    min-height: 48px;
                }
                .char-count {
                    font-size: 12px;
                }
                .links {
                    font-size: 14px;
                    flex-direction: row;
                    flex-wrap: wrap;
                    gap: 16px;
                }
                .links a {
                    padding: 8px 0;
                    min-height: 44px;
                    display: flex;
                    align-items: center;
                }
            }

            @media (max-width: 480px) {
                body {
                    padding: 12px;
                    padding-top: 56px; /* Reduced from 70px to match thinner header */
                }

                .mobile-header {
                    display: flex;
                }

                .container {
                    padding: 0;
                }
                .writingarea {
                    width: 100%;
                }
                input[type="text"] {
                    font-size: 22px;
                    height: 48px;
                }
                input[type="text"].author-input {
                    font-size: 16px;
                    height: 32px;
                }
                textarea {
                    font-size: 16px;
                    min-height: 180px;
                }

                /* Hide the original sidebar elements on mobile */
                .sidebar {
                    display: none;
                }

                /* Mobile header styles */
                .mobile-header .char-count {
                    font-size: 11px; /* Slightly smaller */
                    margin-bottom: 0;
                    flex: 1;
                }

                .mobile-header button {
                    padding: 8px 16px; /* Reduced padding */
                    font-size: 14px; /* Slightly smaller */
                    min-height: 32px; /* Reduced height */
                    margin-bottom: 0;
                    margin-left: 12px;
                }

                .links {
                    display: none; /* Hide links on mobile since they're not in header */
                }
            }
        </style>
    </head>
    <body>
        <!-- Mobile Header -->
        <div class="mobile-header">
            <div class="char-count" id="mobileCharCount">
                <svg class="progress-circle" id="mobileProgressCircle">
                    <circle class="background" cx="8" cy="8" r="6"></circle>
                    <circle
                        class="progress"
                        cx="8"
                        cy="8"
                        r="6"
                        stroke-dasharray="37.7"
                        stroke-dashoffset="37.7"
                    ></circle>
                </svg>
                <span>0 / 128,000</span>
            </div>
            <button type="submit" form="publishForm">Publish</button>
        </div>

        <div class="container">
            <div class="writingarea">
                <form
                    action="/create"
                    method="post"
                    id="publishForm"
                    class="content"
                >
                    <input
                        type="text"
                        name="title"
                        placeholder="Title"
                        maxlength="128"
                        title="Mind your opsec. Limited to 128 characters."
                        required
                    />
                    <input
                        type="text"
                        name="alias"
                        placeholder="Alias (optional)"
                        maxlength="32"
                        class="author-input"
                        title="Mind your opsec. Limited to 32 chracters."
                    />
                    <textarea
                        name="content"
                        placeholder="Write something with markdown or type / for formatting options..."
                        maxlength="128000"
                        title="Mind your opsec, be careful what you share."
                        required
                    ></textarea>
                    <input
                        type="hidden"
                        name="csrf_token"
                        value="{{csrf_token}}"
                    />
                </form>
            </div>

            <div class="sidebar">
                <button type="submit" form="publishForm">Publish</button>
                <div class="char-count" id="charCount">
                    <svg class="progress-circle" id="progressCircle">
                        <circle class="background" cx="8" cy="8" r="6"></circle>
                        <circle
                            class="progress"
                            cx="8"
                            cy="8"
                            r="6"
                            stroke-dasharray="37.7"
                            stroke-dashoffset="37.7"
                        ></circle>
                    </svg>
                    <span>0 / 128,000</span>
                </div>
                <div class="links">
                    <a href="/markup" target="_blank">markup guide</a>
                    <a href="/legal" target="_blank">legal &amp; privacy</a>
                    <a href="https://github.com/du82/nonograph" target="_blank"
                        >source code</a
                    >
                </div>
            </div>
        </div>

        <!-- Slash Command Menu -->
        <div class="editor-menu" id="slashMenu"></div>

        <script>
            const textarea = document.querySelector('textarea[name="content"]');
            const charCount = document.getElementById("charCount");
            const mobileCharCount = document.getElementById("mobileCharCount");
            const form = document.getElementById("publishForm");
            const slashMenu = document.getElementById("slashMenu");
            const progressCircle = document.getElementById("progressCircle");
            const mobileProgressCircle = document.getElementById(
                "mobileProgressCircle",
            );

            let slashMenuActive = false;
            let slashPosition = -1;
            let selectedMenuIndex = 0;
            let slashQuery = "";

            const menuItems = [
                {
                    label: "Heading 1",
                    format: "# ",
                    shortcut: "Ctrl+Alt+1",
                    key: "1",
                    altKey: true,
                    blockLevel: true,
                },
                {
                    label: "Heading 2",
                    format: "## ",
                    shortcut: "Ctrl+Alt+2",
                    key: "2",
                    altKey: true,
                    blockLevel: true,
                },
                {
                    label: "Heading 3",
                    format: "### ",
                    shortcut: "Ctrl+Alt+3",
                    key: "3",
                    altKey: true,
                    blockLevel: true,
                },
                {
                    label: "Heading 4",
                    format: "#### ",
                    shortcut: "Ctrl+Alt+4",
                    key: "4",
                    altKey: true,
                    blockLevel: true,
                },
                {
                    label: "Bold",
                    format: "****",
                    cursorOffset: -2,
                    shortcut: "Ctrl+B",
                    key: "b",
                    inline: true,
                },
                {
                    label: "Italic",
                    format: "**",
                    cursorOffset: -1,
                    shortcut: "Ctrl+I",
                    key: "i",
                    inline: true,
                },
                {
                    label: "Underline",
                    format: "__",
                    cursorOffset: -1,
                    shortcut: "Ctrl+U",
                    key: "u",
                    inline: true,
                },
                {
                    label: "Strikethrough",
                    format: "~~",
                    cursorOffset: -1,
                    shortcut: "Ctrl+Shift+X",
                    key: "x",
                    shiftKey: true,
                    inline: true,
                },
                {
                    label: "Superscript",
                    format: "^^",
                    cursorOffset: -1,
                    shortcut: "Ctrl+Shift+P",
                    key: "p",
                    shiftKey: true,
                    inline: true,
                },
                {
                    label: "Highlight",
                    format: "====",
                    cursorOffset: -2,
                    shortcut: "Ctrl+H",
                    key: "h",
                    inline: true,
                },
                {
                    label: "Inline Code",
                    format: "``",
                    cursorOffset: -1,
                    shortcut: "Ctrl+E",
                    key: "e",
                    inline: true,
                },
                {
                    label: "Code Block",
                    format: "\n```\n\n```",
                    cursorOffset: -4,
                    shortcut: "Ctrl+Shift+C",
                    key: "c",
                    shiftKey: true,
                    blockLevel: true,
                },
                {
                    label: "Link",
                    format: "[](url)",
                    cursorOffset: -6,
                    shortcut: "Ctrl+K",
                    key: "k",
                    inline: true,
                },
                {
                    label: "Image",
                    format: "![](url)",
                    cursorOffset: -6,
                    shortcut: "Ctrl+Shift+I",
                    key: "i",
                    shiftKey: true,
                    inline: true,
                },
                {
                    label: "Video",
                    format: "![](url)",
                    cursorOffset: -6,
                    shortcut: "Ctrl+Shift+V",
                    key: "v",
                    shiftKey: true,
                    inline: true,
                },
                {
                    label: "Blockquote",
                    format: "> ",
                    shortcut: "Ctrl+Shift+9",
                    key: "9",
                    shiftKey: true,
                    blockLevel: true,
                },
                {
                    label: "Bullet List",
                    format: "- ",
                    shortcut: "Ctrl+Shift+8",
                    key: "8",
                    shiftKey: true,
                    blockLevel: true,
                },
                {
                    label: "Numbered List",
                    format: "1. ",
                    shortcut: "Ctrl+Shift+7",
                    key: "7",
                    shiftKey: true,
                    blockLevel: true,
                },
                {
                    label: "Table",
                    format: "| Column 1 | Column 2 |\n|----------|----------|\n| Cell 1   | Cell 2   |",
                    cursorOffset: -47,
                    shortcut: "Ctrl+T",
                    key: "t",
                    blockLevel: true,
                },
                {
                    label: "Footnote Reference",
                    format: "[^1]",
                    shortcut: "Ctrl+Shift+R",
                    key: "r",
                    shiftKey: true,
                    inline: true,
                },
                {
                    label: "Inline Footnote",
                    format: "^[]",
                    cursorOffset: -1,
                    shortcut: "Ctrl+Shift+F",
                    key: "f",
                    shiftKey: true,
                    inline: true,
                },
                {
                    label: "Hidden Text",
                    format: "##",
                    cursorOffset: -1,
                    inline: true,
                },
                {
                    label: "Comment",
                    format: "// ",
                    shortcut: "Ctrl+/",
                    blockLevel: true,
                },
                {
                    label: "Thin Line Divider",
                    format: "\n---\n",
                    shortcut: "Ctrl+Shift+D",
                    key: "d",
                    shiftKey: true,
                    blockLevel: true,
                },
                {
                    label: "Double Line Divider",
                    format: "\n===\n",
                    blockLevel: true,
                },
                {
                    label: "Single Asterisk Divider",
                    format: "\n-*-\n",
                    blockLevel: true,
                },
                {
                    label: "Three Stars Divider",
                    format: "\n***\n",
                    blockLevel: true,
                },
            ];

            // Check if device is mobile
            function isMobile() {
                return window.innerWidth <= 480;
            }

            function isAtLineStart() {
                // When slash menu is active, use slash position for context
                const checkPos = slashMenuActive
                    ? slashPosition
                    : textarea.selectionStart;
                const textBeforeCheck = textarea.value.substring(0, checkPos);

                if (checkPos === 0) return true;

                const lastChar = textBeforeCheck.charAt(
                    textBeforeCheck.length - 1,
                );

                // At line start if previous char is newline or we're at document start
                return lastChar === "\n" || textBeforeCheck.length === 0;
            }

            function getContextualMenuItems() {
                const atLineStart = isAtLineStart();

                let filteredItems = menuItems.filter((item) => {
                    // Always show items that work both inline and at line start
                    if (!item.blockLevel && !item.inline) return true;

                    // At line start: show all items
                    if (atLineStart) return true;

                    // In middle of line: only show inline items
                    return item.inline === true;
                });

                // Further filter by search query if there's text after slash
                if (slashQuery.trim()) {
                    filteredItems = filteredItems.filter((item) =>
                        item.label
                            .toLowerCase()
                            .includes(slashQuery.toLowerCase()),
                    );
                }

                return filteredItems;
            }

            function autoResize(element) {
                element.style.height = "auto";
                element.style.height = element.scrollHeight + "px";
            }

            function updateProgressCircle(percentage, circleElement) {
                if (!circleElement) return;

                const progressCircle = circleElement.querySelector(".progress");
                const circumference = 2 * Math.PI * 6; // radius = 6
                const offset =
                    circumference - (percentage / 100) * circumference;

                progressCircle.style.strokeDashoffset = offset;

                // Update color based on percentage
                if (percentage >= 100) {
                    progressCircle.style.stroke = "#e74c3c"; // Red
                } else if (percentage >= 75) {
                    // Changed from 90 to 75
                    progressCircle.style.stroke = "#f39c12"; // Yellow/Orange
                } else {
                    progressCircle.style.stroke = "#666"; // Dark grey
                }
            }

            function updateCharCount() {
                const count = textarea.value.length;
                const button = document.querySelector('button[type="submit"]');
                const limit = 128000;
                const countText =
                    count.toLocaleString() + " / " + limit.toLocaleString();
                const percentage = (count / limit) * 100;

                // Update desktop character count
                if (charCount) {
                    const span = charCount.querySelector("span");
                    if (span) span.textContent = countText;
                    updateProgressCircle(percentage, progressCircle);
                }

                // Update mobile character count
                if (mobileCharCount) {
                    const span = mobileCharCount.querySelector("span");
                    if (span) span.textContent = countText;
                    updateProgressCircle(percentage, mobileProgressCircle);
                }

                // Update button state and character count styling
                if (count > limit) {
                    if (charCount) charCount.classList.add("over-limit");
                    if (mobileCharCount)
                        mobileCharCount.classList.add("over-limit");
                    button.disabled = true;
                } else {
                    if (charCount) charCount.classList.remove("over-limit");
                    if (mobileCharCount)
                        mobileCharCount.classList.remove("over-limit");
                    button.disabled = false;
                }
            }

            function getCursorHorizontalPosition() {
                const cursorPos = textarea.selectionStart;
                const textUpToCursor = textarea.value.substring(0, cursorPos);
                const lines = textUpToCursor.split("\n");
                const currentLineText = lines[lines.length - 1];

                // Get textarea positioning and styling
                const rect = textarea.getBoundingClientRect();
                const styles = window.getComputedStyle(textarea);
                const paddingLeft = parseFloat(styles.paddingLeft);

                // Create temporary element to measure text width
                const measurer = document.createElement("span");
                measurer.style.font = styles.font;
                measurer.style.fontSize = styles.fontSize;
                measurer.style.fontFamily = styles.fontFamily;
                measurer.style.visibility = "hidden";
                measurer.style.position = "absolute";
                measurer.style.whiteSpace = "pre";
                measurer.textContent = currentLineText;
                document.body.appendChild(measurer);

                const textWidth = measurer.getBoundingClientRect().width;
                document.body.removeChild(measurer);

                // Calculate horizontal cursor position
                return rect.left + paddingLeft + textWidth;
            }

            function showSlashMenu(x, y) {
                slashMenuActive = true; // Set this first so isAtLineStart() works correctly
                const contextualItems = getContextualMenuItems();
                slashMenu.innerHTML = "";
                contextualItems.forEach((item, index) => {
                    const div = document.createElement("div");
                    div.className =
                        "menu-item" + (index === 0 ? " selected" : "");
                    div.innerHTML = `
                    <span class="menu-label">${item.label}</span>
                    ${item.shortcut ? `<span class="menu-shortcut">${item.shortcut}</span>` : ""}
                `;
                    div.addEventListener("click", () => applyFormat(item));
                    slashMenu.appendChild(div);
                });

                // Get horizontal cursor position and textarea bounds
                const cursorX = getCursorHorizontalPosition();
                const textareaRect = textarea.getBoundingClientRect();

                // Calculate optimal position
                const menuWidth = 300;
                const menuHeight = Math.min(
                    contextualItems.length * 40 + 10,
                    300,
                );
                // Use fixed height for positioning to maintain consistency
                const positioningHeight = 50; // Height of single item for positioning
                const padding = 10;

                // Use actual cursor X position, but keep within textarea bounds
                let menuX = cursorX;
                if (menuX + menuWidth > textareaRect.right - padding) {
                    menuX = textareaRect.right - menuWidth - padding;
                }
                if (menuX < textareaRect.left + padding) {
                    menuX = textareaRect.left + padding;
                }

                // Always position menu below the cursor line
                let menuY = y + 35; // Fixed offset below cursor line

                // Only adjust if menu would go completely outside textarea
                // Use fixed positioning height so position is consistent
                if (menuY + positioningHeight > textareaRect.bottom) {
                    // If menu is too tall for textarea, position at bottom and let it scroll
                    menuY = Math.max(
                        y - positioningHeight - 15,
                        textareaRect.top + padding,
                    );
                }

                slashMenu.style.left = menuX + "px";
                slashMenu.style.top = menuY + "px";
                slashMenu.classList.add("active");
                selectedMenuIndex = 0;

                // Reset scroll position to top
                slashMenu.scrollTop = 0;
            }

            function hideSlashMenu() {
                slashMenu.classList.remove("active");
                slashMenuActive = false;
                slashPosition = -1;
                slashQuery = "";
            }

            function updateMenuSelection() {
                const items = slashMenu.querySelectorAll(".menu-item");
                const contextualItems = getContextualMenuItems();

                items.forEach((item, index) => {
                    if (index === selectedMenuIndex) {
                        item.classList.add("selected");
                        // Scroll the selected item into view
                        item.scrollIntoView({
                            block: "nearest",
                            behavior: "smooth",
                        });
                    } else {
                        item.classList.remove("selected");
                    }
                });
            }

            function applyFormat(item, selectedText = null) {
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;

                if (slashMenuActive) {
                    // Remove the slash and any search query
                    const before = text.substring(0, slashPosition);
                    const after = text.substring(start);
                    const newText = before + item.format + after;
                    textarea.value = newText;

                    const cursorPos =
                        slashPosition +
                        item.format.length +
                        (item.cursorOffset || 0);
                    textarea.setSelectionRange(cursorPos, cursorPos);
                    hideSlashMenu();
                } else {
                    // Apply to selection or insert at cursor
                    selectedText = selectedText || text.substring(start, end);
                    const hasSelection = start !== end;
                    let newText, cursorPos;

                    if (item.label === "Bold") {
                        if (hasSelection) {
                            newText =
                                text.substring(0, start) +
                                "**" +
                                selectedText +
                                "**" +
                                text.substring(end);
                            cursorPos = end + 4;
                        } else {
                            newText =
                                text.substring(0, start) +
                                "****" +
                                text.substring(end);
                            cursorPos = start + 2;
                        }
                    } else if (item.label === "Italic") {
                        if (hasSelection) {
                            newText =
                                text.substring(0, start) +
                                "*" +
                                selectedText +
                                "*" +
                                text.substring(end);
                            cursorPos = end + 2;
                        } else {
                            newText =
                                text.substring(0, start) +
                                "**" +
                                text.substring(end);
                            cursorPos = start + 1;
                        }
                    } else if (item.label === "Underline") {
                        if (hasSelection) {
                            newText =
                                text.substring(0, start) +
                                "_" +
                                selectedText +
                                "_" +
                                text.substring(end);
                            cursorPos = end + 2;
                        } else {
                            newText =
                                text.substring(0, start) +
                                "__" +
                                text.substring(end);
                            cursorPos = start + 1;
                        }
                    } else if (item.label === "Strikethrough") {
                        if (hasSelection) {
                            newText =
                                text.substring(0, start) +
                                "~" +
                                selectedText +
                                "~" +
                                text.substring(end);
                            cursorPos = end + 2;
                        } else {
                            newText =
                                text.substring(0, start) +
                                "~~" +
                                text.substring(end);
                            cursorPos = start + 1;
                        }
                    } else if (item.label === "Superscript") {
                        if (hasSelection) {
                            newText =
                                text.substring(0, start) +
                                "^" +
                                selectedText +
                                "^" +
                                text.substring(end);
                            cursorPos = end + 2;
                        } else {
                            newText =
                                text.substring(0, start) +
                                "^^" +
                                text.substring(end);
                            cursorPos = start + 1;
                        }
                    } else if (item.label === "Highlight") {
                        if (hasSelection) {
                            newText =
                                text.substring(0, start) +
                                "==" +
                                selectedText +
                                "==" +
                                text.substring(end);
                            cursorPos = end + 4;
                        } else {
                            newText =
                                text.substring(0, start) +
                                "====" +
                                text.substring(end);
                            cursorPos = start + 2;
                        }
                    } else if (item.label === "Inline Code") {
                        if (hasSelection) {
                            newText =
                                text.substring(0, start) +
                                "`" +
                                selectedText +
                                "`" +
                                text.substring(end);
                            cursorPos = end + 2;
                        } else {
                            newText =
                                text.substring(0, start) +
                                "``" +
                                text.substring(end);
                            cursorPos = start + 1;
                        }
                    } else if (item.label === "Code Block") {
                        if (hasSelection) {
                            newText =
                                text.substring(0, start) +
                                "```\n" +
                                selectedText +
                                "\n```" +
                                text.substring(end);
                            cursorPos = end + 8;
                        } else {
                            newText =
                                text.substring(0, start) +
                                "```\n\n```" +
                                text.substring(end);
                            cursorPos = start + 4;
                        }
                    } else if (item.label === "Link") {
                        if (hasSelection) {
                            newText =
                                text.substring(0, start) +
                                "[" +
                                selectedText +
                                "](url)" +
                                text.substring(end);
                            cursorPos = start + selectedText.length + 3;
                        } else {
                            newText =
                                text.substring(0, start) +
                                "[](url)" +
                                text.substring(end);
                            cursorPos = start + 1;
                        }
                    } else if (item.label === "Image") {
                        if (hasSelection) {
                            newText =
                                text.substring(0, start) +
                                "![" +
                                selectedText +
                                "](url)" +
                                text.substring(end);
                            cursorPos = start + selectedText.length + 4;
                        } else {
                            newText =
                                text.substring(0, start) +
                                "![](url)" +
                                text.substring(end);
                            cursorPos = start + 2;
                        }
                    } else {
                        // Generic handling for other formats
                        newText =
                            text.substring(0, start) +
                            item.format +
                            text.substring(end);
                        cursorPos =
                            start +
                            item.format.length +
                            (item.cursorOffset || 0);
                    }

                    textarea.value = newText;
                    textarea.setSelectionRange(cursorPos, cursorPos);
                }

                updateCharCount();
                autoResize(textarea);
                textarea.focus();
            }

            // Textarea event listeners
            textarea.addEventListener("input", function (e) {
                const cursorPos = this.selectionStart;
                const textBeforeCursor = this.value.substring(0, cursorPos);
                const lastChar = textBeforeCursor.charAt(
                    textBeforeCursor.length - 1,
                );

                if (
                    lastChar === "/" &&
                    (cursorPos === 1 ||
                        textBeforeCursor.charAt(cursorPos - 2) === "\n" ||
                        textBeforeCursor.charAt(cursorPos - 2) === " ")
                ) {
                    const rect = this.getBoundingClientRect();
                    const lines = textBeforeCursor.split("\n");
                    const currentLine = lines.length;
                    const lineHeight = 28.8;
                    const styles = window.getComputedStyle(this);
                    const paddingTop = parseFloat(styles.paddingTop);

                    slashPosition = cursorPos - 1;
                    slashQuery = "";

                    // Calculate cursor Y position within textarea
                    const cursorY =
                        rect.top + paddingTop + (currentLine - 1) * lineHeight;

                    showSlashMenu(rect.left, cursorY);
                } else if (slashMenuActive) {
                    // Check if we're still typing after the slash
                    const textAfterSlash = textBeforeCursor.substring(
                        slashPosition + 1,
                    );

                    // If cursor is still after the slash and no spaces/newlines, update query
                    if (
                        cursorPos > slashPosition &&
                        !textAfterSlash.includes(" ") &&
                        !textAfterSlash.includes("\n")
                    ) {
                        slashQuery = textAfterSlash;
                        selectedMenuIndex = 0; // Reset to first item

                        const rect = this.getBoundingClientRect();
                        const lines = textBeforeCursor.split("\n");
                        const currentLine = lines.length;
                        const lineHeight = 28.8;
                        const styles = window.getComputedStyle(this);
                        const paddingTop = parseFloat(styles.paddingTop);

                        // Calculate cursor Y position within textarea
                        const cursorY =
                            rect.top +
                            paddingTop +
                            (currentLine - 1) * lineHeight;

                        showSlashMenu(rect.left, cursorY);
                    } else {
                        hideSlashMenu();
                    }
                }

                updateCharCount();
                autoResize(this);
            });

            textarea.addEventListener("keydown", function (e) {
                if (slashMenuActive) {
                    const contextualItems = getContextualMenuItems();

                    // If no items match the search, close menu
                    if (contextualItems.length === 0) {
                        if (e.key === "Escape" || e.key === "Backspace") {
                            e.preventDefault();
                            hideSlashMenu();
                        }
                        return;
                    }

                    if (e.key === "ArrowDown") {
                        e.preventDefault();
                        selectedMenuIndex =
                            (selectedMenuIndex + 1) % contextualItems.length;
                        updateMenuSelection();
                    } else if (e.key === "ArrowUp") {
                        e.preventDefault();
                        selectedMenuIndex =
                            (selectedMenuIndex - 1 + contextualItems.length) %
                            contextualItems.length;
                        updateMenuSelection();
                    } else if (e.key === "Enter" || e.key === "Tab") {
                        e.preventDefault();
                        applyFormat(contextualItems[selectedMenuIndex]);
                    } else if (e.key === "Escape") {
                        e.preventDefault();
                        hideSlashMenu();
                    } else if (e.key === "Backspace") {
                        // If backspacing and we're at the slash, close menu
                        const cursorPos = this.selectionStart;
                        if (cursorPos <= slashPosition + 1) {
                            hideSlashMenu();
                        }
                    }
                } else {
                    // Keyboard shortcuts
                    const item = menuItems.find((item) => {
                        if (!item.key) return false;

                        const keyMatches =
                            e.key.toLowerCase() === item.key.toLowerCase();
                        const ctrlMatches = e.ctrlKey || e.metaKey;
                        const shiftMatches = item.shiftKey
                            ? e.shiftKey
                            : !e.shiftKey;
                        const altMatches = item.altKey ? e.altKey : !e.altKey;

                        return (
                            keyMatches &&
                            ctrlMatches &&
                            shiftMatches &&
                            altMatches
                        );
                    });

                    if (item) {
                        e.preventDefault();
                        applyFormat(item);
                    }
                }
            });

            // Click outside to close menus
            document.addEventListener("click", function (e) {
                if (!slashMenu.contains(e.target) && e.target !== textarea) {
                    hideSlashMenu();
                }
            });

            form.addEventListener("submit", function (e) {
                const limit = 128000;
                if (textarea.value.length > limit) {
                    e.preventDefault();
                    alert(
                        "Content exceeds " +
                            limit.toLocaleString() +
                            " character limit.",
                    );
                    return false;
                }
            });

            updateCharCount();

            // Handle window resize to adjust menu if needed
            window.addEventListener("resize", function () {
                if (slashMenuActive) {
                    hideSlashMenu();
                }
            });
        </script>
    </body>
</html>
